# 作業計画

## 現在の作業

### [REQ-006] Gradioベースのなすみそ学習ツールUI開発

#### 準備
- [ ] 既存スクリプトの動作確認（prepare_images.py, auto_caption.py, add_common_tag.py）
- [ ] requirements.txtの依存関係確認と必要なパッケージの追加
- [ ] Google Drive API認証情報のセットアップ方法を調査
- [ ] プロジェクト構造の決定（app.py配置場所、モジュール分割）

#### 実装フェーズ1: 基本構造とタブ1（画像準備） ✅ 完了
- [x] app.pyの基本構造作成（Gradio 3タブレイアウト）
- [x] タブ1: 画像準備タブのUI構築
  - [x] フォルダ選択UI（デフォルト: projects/nasumiso_v1/1_raw_images）
  - [x] テーブル形式レイアウト（4列構成：フォルダパス / 画像枚数 / 追加タグ / 操作）
  - [x] 3行の入力フォルダ欄（将来の複数フォルダ対応を想定）
  - [x] 追加タグ入力欄（カンマ区切り）
  - [x] 画像枚数ボタン（クリックで詳細情報表示）
  - [x] ファイル一覧表示（共通の詳細表示エリア）
  - [x] 「変換開始」ボタン
  - [x] リアルタイム進捗表示エリア
- [x] タブ1: 既存スクリプト統合ロジック
  - [x] prepare_images.pyの実行処理
  - [x] auto_caption.pyの実行処理（しきい値0.35固定）
  - [x] add_common_tag.pyの実行処理（nasumiso_style固定 + 追加タグ対応）
  - [x] 追加タグ機能（カンマ区切りで複数タグを指定可能）
  - [x] 進捗表示の実装（ファイル名、進捗%）
  - [x] エラーハンドリング（ファイル不存在、処理失敗）

**実装完了日**:
- 2025-11-08（基本構造）
- 2025-11-11（追加タグ機能、テーブル形式レイアウト、ファイル一覧表示）

**主要コミット**:
- 9e07902: feat: Gradio WebUIに画像前処理パイプライン機能を実装
- a689963: refactor: 画像準備タブのレイアウトをテーブル形式に改善し、ファイル一覧表示をシンプル化
- 2c895ec: feat: 画像準備タブに追加タグ機能を実装

**実装内容**:
- Gradio 5.x環境で実装（Gradio 4.44.1から5.xへ移行）
- タブ1「画像準備」に3ステップパイプライン実装（リサイズ→タグ付け→共通タグ追加）
- リアルタイムプログレスバー対応（gr.Progress API）
- テーブル形式UI（4列構成、将来的に複数フォルダ追加可能）
- 追加タグ機能（nasumiso_styleに加えてカンマ区切りで追加タグを指定）
- 画像枚数ボタンクリックでファイル一覧を下部の共通エリアに表示
- フォルダを開くボタン（MacのFinderで開く）

#### 実装フェーズ2: タブ2（タグ編集）
- [ ] タブ2: タグ編集タブのUI構築
  - [ ] 画像一覧表示（サムネイル、projects/nasumiso_v1/3_tagged/）
  - [ ] 画像選択UI
  - [ ] タグテキストエリア（編集可能）
  - [ ] 保存ボタン
  - [ ] 固有タグ一括追加UI
- [ ] タブ2: タグ編集ロジック
  - [ ] 画像一覧の読み込み処理
  - [ ] タグファイル（.txt）の読み込み処理
  - [ ] タグ編集・保存処理（.txtファイル更新）
  - [ ] 固有タグ一括追加処理（複数画像選択対応）
  - [ ] エラーハンドリング

#### 実装フェーズ3: タブ3（学習・モデル管理）基本機能
- [ ] タブ3: 学習・モデル管理タブのUI構築
  - [ ] Google Drive連携セクション
    - [ ] 「Google Driveにアップロード」ボタン
    - [ ] 進捗表示エリア
  - [ ] Google Colab連携セクション
    - [ ] 「Google Colabで学習」リンク
  - [ ] モデル管理セクション
    - [ ] 「モデルダウンロード」ボタン
    - [ ] 「Stable Diffusionに配置」ボタン
    - [ ] モデル一覧表示
- [ ] Google Drive API統合
  - [ ] OAuth 2.0認証フロー実装
  - [ ] credentials.json, token.jsonの管理ロジック
  - [ ] ファイルアップロード処理（3_tagged/ → /MyDrive/NasuTomo/datasets/）
  - [ ] 進捗表示（アップロード中のファイル名、進捗%）
  - [ ] エラーハンドリング（認証失敗、ネットワークエラー）
- [ ] Google Colab連携
  - [ ] notebooks/train_lora_nasutomo.ipynbを開くリンク実装
- [ ] モデル管理機能
  - [ ] Google Driveからモデルダウンロード処理
  - [ ] ダウンロード先設定（projects/nasumiso_v1/lora_models/）
  - [ ] Stable Diffusion WebUIへの自動配置処理
    - [ ] Mac: ~/stable-diffusion-webui/models/Lora/
    - [ ] Windows: %USERPROFILE%\Documents\stable-diffusion-webui\models\Lora\
  - [ ] エラーハンドリング

#### 実装フェーズ4: クロスプラットフォーム対応
- [ ] パス操作をPathlibに統一
- [ ] 環境依存処理の分岐実装（Mac/Windows）
- [ ] 設定ファイル（config.json）の実装
  - [ ] Stable Diffusion WebUIパス設定
  - [ ] 学習モード設定（training_mode: colab/local）
  - [ ] デフォルト設定の提供
- [ ] 起動スクリプト作成
  - [ ] start_nasumiso_trainer.sh（Mac用）
  - [ ] start_nasumiso_trainer.bat（Windows用）
  - [ ] 実行権限設定

#### 実装フェーズ5: ログとエラーハンドリング
- [ ] ログ出力機能の実装
  - [ ] logs/ディレクトリの自動作成
  - [ ] 処理履歴のログファイル出力
  - [ ] タイムスタンプ付きログ
- [ ] エラーメッセージの統一
  - [ ] わかりやすいエラーメッセージ表示
  - [ ] エラー時の推奨アクション提示
- [ ] .gitignore更新
  - [ ] credentials.json, token.jsonを除外
  - [ ] logs/を除外

#### テスト（Mac環境）
- [x] タブ1: 画像準備機能のテスト
  - [x] フォルダ選択 → 変換実行 → 正常完了（完了: 2025-11-08）
  - [x] 進捗表示の確認（完了: 2025-11-08）
  - [x] テーブル形式UIの表示確認（完了: 2025-11-11）
  - [x] 追加タグ入力 → 変換実行 → タグが正しく追加されることを確認（完了: 2025-11-11）
  - [x] 画像枚数ボタン → ファイル一覧表示の確認（完了: 2025-11-11）
  - [x] フォルダを開くボタンの動作確認（完了: 2025-11-11）
  - [ ] エラー時の挙動確認（空フォルダ、無効パスなど）
- [ ] タブ2: タグ編集機能のテスト
  - [ ] 画像一覧表示確認
  - [ ] タグ編集・保存確認
  - [ ] 固有タグ一括追加確認
- [ ] タブ3: Google Drive連携のテスト
  - [ ] OAuth 2.0認証フロー確認
  - [ ] ファイルアップロード確認
  - [ ] 進捗表示確認
  - [ ] エラーハンドリング確認
- [ ] タブ3: モデル管理のテスト
  - [ ] モデルダウンロード確認
  - [ ] Stable Diffusionへの配置確認（Mac）
- [ ] 起動スクリプトのテスト（Mac）
  - [ ] ./start_nasumiso_trainer.sh で起動確認
  - [ ] ポート7861で起動確認
- [ ] エンドツーエンドテスト（Mac環境）
  - [ ] 全工程を通した動作確認（画像準備 → タグ編集 → アップロード → モデル配置）
- [ ] ログ出力の確認

#### ドキュメント作成
- [ ] README.md更新
  - [ ] セットアップ手順（依存パッケージインストール）
  - [ ] Google Drive API認証情報の取得・設定方法
  - [ ] 起動方法（Mac/Windows）
  - [ ] 各タブの使い方
  - [ ] トラブルシューティング
- [ ] config.json.exampleの作成（サンプル設定ファイル）

#### テスト結果

**タブ1: 画像準備機能（2025-11-08実施）**
- ✅ フォルダ選択と変換実行が正常に完了
- ✅ リアルタイムプログレスバー表示が正常に動作
- ✅ 3ステップパイプライン（リサイズ→タグ付け→共通タグ追加）が正常に実行される
- ✅ 処理結果メッセージが適切に表示される

**タブ1: 追加タグ機能とUI改善（2025-11-11実施）**
- ✅ テーブル形式UI（4列構成）が正常に表示される
- ✅ 3行の入力フォルダ欄が表示される（現在は1行目のみ使用）
- ✅ 追加タグ入力欄にカンマ区切りでタグを入力できる
- ✅ 追加タグ「chara_nasumiso」を入力して変換実行
  - 結果: `nasumiso_style, chara_nasumiso` が全画像のタグファイルの先頭に追加された
- ✅ 画像枚数ボタンをクリックすると、下部の共通エリアにファイル一覧が表示される
- ✅ フォルダを開くボタンでMacのFinderが開く
- ✅ 複数タグ（カンマ区切り）の動作確認
  - 入力例: `chara_nasumiso, 1boy`
  - 結果: `nasumiso_style, chara_nasumiso, 1boy` が正しく追加された
- ✅ 空欄の場合は `nasumiso_style` のみが追加される

**既知の課題**:
- エラーハンドリングの詳細テスト（空フォルダ、無効パス）は未実施
- タブ2、タブ3は未実装

---

## 完了した要件の作業計画について

完了した要件の作業計画は `completed/REQ-XXX/work-plan.md` に移動されています。

---

## 作業計画テンプレート

新しい作業計画を作成する際は、以下の形式を使用してください：

### [REQ-XXX] タイトル

#### 準備
- [ ] [準備タスク1]
- [ ] [準備タスク2]

#### 実装
- [ ] [実装タスク1]
- [ ] [実装タスク2]
- [ ] [実装タスク3]

#### テスト
- [ ] [テストタスク1]
- [ ] [テストタスク2]

#### テスト結果
（テスト実行後、ここに結果を記録）

---

## 使い方

### Step 2: 作業計画の作成
- Claude Code が requirements.md の要件を元に、このファイルにチェックリストを作成

### Step 4: 実装中
- Claude Code が各タスクを `- [x]` に変更しながら進捗を管理

### Step 5: テスト実行
- Claude Code がテストを実行し、結果を「テスト結果」セクションに記録
- 問題が発見された場合は notes.md に詳細を記録

### Step 6: 完了処理
- 開発者の指示で completed/REQ-XXX/work-plan.md に移動
