# NasumisoCreator - 実装済み機能

## このファイルについて

このファイルは、実装が完了した機能を記録するためのファイルです。
Claude Codeが実装を行った後、このファイルに実装内容を追記していきます。

**関連ドキュメント**:
- プロジェクト全体の知見・ノウハウ: [KNOWLEDGE.md](../KNOWLEDGE.md)
- 完了した要件の詳細: [completed/](../completed/)
- 現在の作業メモ: [notes.md](../notes.md)

---

## 実装履歴

### 2025-10-18: 画像前処理スクリプト（prepare_images.py）

**実装内容**:
- 画像の連番リネーム機能（img001.png, img002.png, ...）
- 512x512へのリサイズ機能（カスタムサイズ対応）
- アスペクト比維持 + 中央クロップによる正方形化
- エラーハンドリング（非画像ファイルのスキップ）
- 処理進捗の表示機能

**関連ファイル**:
- `scripts/prepare_images.py` - メインスクリプト
- `projects/nasumiso_v1/1_raw_images/` - 入力（元画像15枚）
- `projects/nasumiso_v1/2_processed/` - 出力（処理済み画像15枚）
- `scripts/README.md` - 使用方法のドキュメント

**技術的なポイント**:
- **Pillow (PIL)** を使用した高品質画像処理
- **LANCZOSリサンプリング**で画質劣化を最小限に抑制
- **中央クロップ方式**でキャラクターの中心部を保持
- **型ヒント（Type Hints）**を活用した可読性の高いコード
- **argparse**による柔軟なコマンドライン引数設計
- PNG形式での保存（ロスレス・最適化オプション有効）

**テスト結果**:
- 15枚の画像を正常に処理（100%成功率）
- すべての出力画像が512x512のPNG形式
- 画質劣化は許容範囲内（目視確認済み）
- 処理時間: 約1秒（15枚）

---

### 2025-10-19: 自動タグ付けスクリプト（auto_caption.py）

**実装内容**:
- WD14 Tagger v2を使用した自動タグ付け機能
- ONNX Runtimeによる高速推論
- 信頼度しきい値によるタグフィルタリング（デフォルト: 0.35）
- Danbooru形式のタグ出力（カンマ区切り）
- 画像とタグファイル（.txt）のペア出力
- 処理進捗の詳細表示

**関連ファイル**:
- `scripts/auto_caption.py` - メインスクリプト
- `projects/nasumiso_v1/2_processed/` - 入力（処理済み画像15枚）
- `projects/nasumiso_v1/3_tagged/` - 出力（画像15枚 + タグファイル15個）
- `requirements.txt` - 依存ライブラリ（onnxruntime, numpy, pandas, huggingface-hub）
- `scripts/README.md` - 使用方法のドキュメント

**技術的なポイント**:
- **WD14 Tagger v2** (SmilingWolf/wd-v1-4-moat-tagger-v2) を使用
- **ONNX Runtime** で推論を実行（PyTorchよりも軽量・高速）
- **Hugging Face Hub** からモデルとタグリストを自動ダウンロード
- **画像前処理**: 448x448にリサイズ、アスペクト比維持+白パディング
- **確率計算**: モデル出力を直接使用（sigmoid不要）
- **型ヒント完備**: 可読性と保守性の向上
- **エラーハンドリング**: 処理失敗時もスキップして継続

**テスト結果**:
- 15枚の画像を正常に処理（100%成功率）
- 各画像に8-9個の適切なタグを生成
- タグの内容: black_background, monochrome, no_humans, greyscale, general, comic など
- 処理時間: 初回約15秒（モデルダウンロード含む）、2回目以降約5秒
- 出力ファイルサイズ: 各.txtファイル約100バイト

**技術的な課題と解決**:
1. **transformersライブラリ問題**: WD14 Taggerはtransformersに対応していない
   - 解決: ONNX Runtime を使用する方式に変更
2. **シグモイド関数の誤適用**: モデル出力が既に確率値だったため、sigmoid適用で全タグが0.5付近に集中
   - 解決: モデル出力を直接使用するように修正
3. **依存ライブラリの整理**: transformers/timm/torchは不要だった
   - 解決: requirements.txtをonnxruntime中心に書き換え

---

## 実装済み機能一覧

### データ前処理
- [x] 画像リネーム機能（連番形式）
- [x] 画像リサイズ機能（512x512）
- [x] アスペクト比維持 + 中央クロップ
- [x] 自動タグ付け（WD14 Tagger）
- [ ] データセット整形（kohya_ss形式）

### LoRA学習
- [ ] Google Colab学習ノートブック
- [ ] 学習パラメータ設定テンプレート

### 画像生成
- [ ] プロンプトテンプレート
- [ ] 生成ログ管理

### その他
- [x] プロジェクト構造の確立
- [x] 基本ドキュメント整備

---

## 未実装機能

### 次回実装予定（REQ-003）
- [ ] データセット整形スクリプト（organize_dataset.py）
- [ ] kohya_ss標準フォーマット対応

### 次々回実装予定（REQ-004）
- [ ] Google Colab学習ノートブック
- [ ] 学習パラメータ設定テンプレート

### 将来的に実装予定
- [ ] GUIツール化
- [ ] SDXL対応
- [ ] バッチ処理最適化

---

## 技術的な実装メモ

### 工夫した点

**1. 高品質なリサイズアルゴリズム**
- `Image.LANCZOS`を使用し、ダウンスケール時の画質劣化を最小化
- 中央クロップにより、キャラクターの重要部分を保持

**2. 柔軟なコマンドライン設計**
- `--input`, `--output`, `--size`で任意のプロジェクトに対応可能
- ヘルプメッセージに使用例を含めてユーザビリティ向上

**3. エラーハンドリング**
- 非画像ファイル（.DS_Storeなど）を自動スキップ
- 破損ファイルでも処理を継続し、最後に結果を報告

**4. コードの可読性**
- 日本語docstringで仕様を明確化
- 型ヒントで引数・戻り値の型を明示

### 困難だった点

**1. Python環境のバージョン管理**
- システムデフォルトがPython 2.7だったため、`python3`コマンドを明示する必要があった
- 今後はCLAUDE.mdに`python3`使用を明記

**2. Pillowのインストール**
- 実行時にPillowが未インストールだったため、`pip3 install`を実行
- 今後は`requirements.txt`を事前にインストールする手順を明確化

### 改善の余地

**1. 進捗表示の強化**
- 現在は逐次表示だが、tqdmなどを使ったプログレスバー表示も検討可能

**2. リサイズ方式のオプション化**
- 現在は中央クロップ固定だが、パディング方式も選択可能にするとより柔軟

**3. ログファイル出力**
- 現在はコンソール出力のみだが、処理結果をJSONやCSV形式でログ保存すると便利

---

## 使い方

### 実装完了後の記録
1. 実装履歴セクションに日付とタイトルを追加
2. 実装内容、関連ファイル、技術的なポイントを記述
3. 実装済み機能一覧のチェックボックスを更新
4. 技術的な実装メモに工夫・困難・改善点を記録

### 機能の追加
新しい機能カテゴリが必要な場合は、実装済み機能一覧に追加してください。
