# [REQ-002] 画像タグ付け

ステータス: ✅ 完了
作成日: 2025-10-18
完了日: 2025-10-19

## 要求内容

overview.mdの、### 2. 自動タグ付け（キャプション生成）　の実装をお願いします。

## 必要な要素

nasumiso_v1/2_processed/ 以下に、処理済みイラスト画像が配置されています。
実装詳細にあたっては、開発手順書.md の内容も参照して。
**オプション2: ローカルスクリプト** での実装でお願い。

## ゴール

pythonスクリプトにより、3_tagged/に、タグ付け済み画像とタグテキストファイルが配置されている。

## 成果物

- `scripts/auto_caption.py` - WD14 Tagger v2を使った自動タグ付けスクリプト
- `scripts/add_common_tag.py` - 共通タグの一括追加スクリプト
- `scripts/generate_jp_tags.py` - 日本語タグファイル生成スクリプト
- `projects/nasumiso_v1/3_tagged/` - 15枚の画像と30個のタグファイル（英語版15個 + 日本語版15個）
- `requirements.txt` - ONNX Runtime関連の依存関係を追加
- `.gitignore` - タグファイル（.txt）のみGit管理対象に設定
- ドキュメント更新（scripts/README.md, .claude/spec/implementation.md, .claude/notes.md）

## 技術的なハイライト

### 実装上の課題と解決

1. **transformersライブラリ非対応**
   - 問題: WD14 TaggerはHugging Face transformersに対応していない
   - 解決: ONNX Runtimeを使用する方式に変更

2. **sigmoid関数の誤適用**
   - 問題: モデル出力が既に確率値だったため、sigmoid適用で全タグが0.5付近に集中
   - 解決: モデル出力を直接使用するように修正

3. **画像正規化の誤り**（最大の問題）
   - 問題: 自動生成されたタグが画像内容と一致しない（カラー画像に`monochrome`, `no_humans`など）
   - 原因: 0-1正規化（`/ 255.0`）を適用していたが、WD14 Tagger v2は0-255の範囲を期待
   - 解決: `_preprocess_image`メソッドから正規化処理を削除
   - 結果: 正しいタグが生成されるようになった

### タグ管理ワークフローの確立

- Git管理体制を構築（タグファイルの変更履歴を追跡）
- `nasumiso_style`タグを全画像に追加（画風学習のため）
- 日本語タグファイルでイラストレーター確認を容易に

## 特記事項

手動タグ修正のワークフローを確立したことで、今後は：
1. 自動タグ付け → Gitコミット
2. 共通タグ追加 → Gitコミット
3. 手動修正 → Gitコミット

という流れで、タグの品質を段階的に向上させながら履歴を残せるようになった。
