# REQ-002: 画像タグ付け - 作業メモ

## 実装の振り返り

### 最も困難だった問題: 画像正規化の誤り

#### 発覚の経緯
実装完了後、ユーザーから「タグの内容が画像と一致しない」との指摘を受けた。
- カラー画像に対して `black_background`, `monochrome`, `no_humans` などの誤タグが生成
- 特に `no_humans` は致命的（実際には人物が描かれている）

#### 原因調査プロセス
1. 画像読み込みの確認 → 正常（RGB、512x512、正しいピクセル値）
2. 複数画像の比較 → 全画像でほぼ同じ誤タグ → 入力処理の問題と判断
3. 異なる正規化方法をテスト:
   - 0-1正規化（現行）: 誤タグ
   - 0-255（正規化なし）: **正しいタグ**
   - ImageNet正規化: 誤タグ

#### 学んだこと
- **モデルの前処理要件は必ず確認する**: READMEに明記されていなくても、実際の動作で検証が必要
- **早期の出力確認が重要**: 実装完了後、すぐに実際の画像と出力を照らし合わせていれば早期発見できた
- **デバッグの系統的アプローチ**: 複数の仮説を立て、一つずつ検証することの重要性

### transformers非対応問題

#### 経緯
当初、Hugging Face transformersを使用する前提で実装を開始したが、WD14 Taggerは対応していなかった。

#### 解決策
ONNX Runtimeを採用したことで：
- PyTorchより軽量（依存関係が少ない）
- 推論速度も十分（15枚を数秒で処理）
- モデルとタグリストをHugging Face Hubから直接ダウンロード可能

結果的に、より良い実装になった。

### タグ管理ワークフローの設計

#### 背景
自動タグ付けだけでは不十分で、手動修正が必要なケースが多い：
- 誤認識タグの削除（`blue_skin`など）
- プロジェクト固有タグの追加（`nasumiso_style`など）

#### 設計したワークフロー
1. 自動タグ付け → Gitコミット（自動生成版）
2. 共通タグ追加 → Gitコミット
3. 手動レビュー・修正 → Gitコミット（修正版）

#### 工夫した点
- **Git管理**: `.gitignore`を調整してタグファイルのみ管理対象に
  - 画像はプライバシー保護のため除外
  - タグの変更履歴は完全に追跡可能
- **補助スクリプト**: 手作業を減らすツールを提供
  - `add_common_tag.py`: 一括タグ追加
  - `generate_jp_tags.py`: 日本語確認用ファイル生成
- **段階的コミット**: 自動生成 → 共通タグ追加 → 手動修正を分けてコミット

これにより、タグの品質向上プロセスが可視化され、将来の振り返りも容易になった。

## 技術的な発見

### WD14 Tagger v2の特性

1. **入力形式**: 0-255の範囲、(1, H, W, C)形式
2. **出力形式**: 既に確率値（0-1）、sigmoidは不要
3. **推奨しきい値**: 0.35（P=Rポイント: 0.3771）
4. **タグ数**: 9,083種類のDanbooruタグ

### ONNX Runtimeの利点

- 軽量で高速
- Hugging Face Hubとの統合が容易
- PyTorchやTensorFlowより依存関係が少ない

### 実装のベストプラクティス

1. **モデルの仕様確認**: READMEだけでなく、実際の動作で検証
2. **早期の出力確認**: 実装後すぐに実際のデータで検証
3. **段階的なデバッグ**: 仮説を立てて一つずつ検証
4. **Git管理の徹底**: 自動生成と手動修正を明確に分離

## 気付き・感想

### ユーザーフィードバックの価値
実装者視点では気づきにくい問題（タグと画像の不一致）を、ユーザーが即座に発見。
**早期のフィードバックループの重要性**を再認識。

### 完璧な自動化は難しい
自動タグ付けは便利だが、完璧ではない：
- モデルの誤認識（`blue_skin`など）
- プロジェクト固有の要件（`nasumiso_style`の追加）

**自動化 + 手動修正のハイブリッドアプローチ**が現実的。

### ワークフロー設計の重要性
単にスクリプトを作るだけでなく、**使いやすいワークフロー**を設計することで：
- 作業効率が向上
- 品質管理が容易
- 将来のメンテナンスが楽

この視点は、今後の機能実装でも活かせる。

## 改善の余地

### 今後の課題

1. **タグの品質評価**: 自動生成タグの精度を定量的に評価する仕組み
2. **カスタムモデルのファインチューニング**: なすみそさんのイラストに特化したモデル
3. **UIの提供**: コマンドラインだけでなく、GUIでタグ編集できるツール

### 技術的な改善案

1. **バッチ処理の最適化**: 現在は1枚ずつ処理しているが、バッチ処理で高速化可能
2. **キャッシュ機構**: モデルの再読み込みを避ける
3. **並列処理**: 複数画像を並列で処理

## 完了条件の達成状況

✅ すべて達成

1. ✅ `scripts/auto_caption.py`が正常に動作する
2. ✅ `projects/nasumiso_v1/3_tagged/`に15枚の画像と対応する.txtファイルが配置されている
3. ✅ タグがDanbooru形式で適切に生成されている
4. ✅ エラーハンドリングが適切に実装されている
5. ✅ ドキュメントが更新されている
6. ✅ タグ管理ワークフローが確立されている（追加達成）

## 参照

- 詳細な実装内容: `.claude/spec/implementation.md`
- 作業計画とチェックリスト: `.claude/completed/REQ-002/work-plan.md`
- 要件詳細: `.claude/completed/REQ-002/requirement.md`
