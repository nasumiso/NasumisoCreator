#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Nasumiso LoRA Training Assistant - Gradio WebUI

ãªã™ã¿ãLoRAå­¦ç¿’ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«
"""

import json
import logging
import sys
from datetime import datetime
from pathlib import Path
from typing import Dict, List, Optional, Tuple

import gradio as gr

# æ—¢å­˜ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
sys.path.append(str(Path(__file__).parent / "scripts"))
from prepare_images import get_image_files, resize_and_crop
from auto_caption import WD14Tagger
from add_common_tag import add_tag_to_file

# ãƒ­ã‚°è¨­å®š
LOG_DIR = Path(__file__).parent / "logs"
LOG_DIR.mkdir(exist_ok=True)

log_file = LOG_DIR / f"nasumiso_trainer_{datetime.now().strftime('%Y%m%d_%H%M%S')}.log"
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler(log_file, encoding='utf-8'),
        logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹
CONFIG_FILE = Path(__file__).parent / "config.json"

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®š
DEFAULT_CONFIG = {
    "sd_webui_path": str(Path.home() / "stable-diffusion-webui" / "models" / "Lora"),
    "training_mode": "colab",
    "default_raw_images_dir": "projects/nasumiso_v1/1_raw_images",
    "default_processed_dir": "projects/nasumiso_v1/2_processed",
    "default_tagged_dir": "projects/nasumiso_v1/3_tagged",
    "default_lora_models_dir": "projects/nasumiso_v1/lora_models",
    "image_size": 512,
    "caption_threshold": 0.35,
    "common_tag": "nasumiso_style"
}


def load_config() -> Dict:
    """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€"""
    if CONFIG_FILE.exists():
        try:
            with open(CONFIG_FILE, 'r', encoding='utf-8') as f:
                config = json.load(f)
                logger.info(f"è¨­å®šã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: {CONFIG_FILE}")
                return {**DEFAULT_CONFIG, **config}
        except Exception as e:
            logger.error(f"è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: {e}")
            return DEFAULT_CONFIG.copy()
    return DEFAULT_CONFIG.copy()


def save_config(config: Dict) -> bool:
    """è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã™ã‚‹"""
    try:
        with open(CONFIG_FILE, 'w', encoding='utf-8') as f:
            json.dump(config, f, indent=2, ensure_ascii=False)
        logger.info(f"è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ: {CONFIG_FILE}")
        return True
    except Exception as e:
        logger.error(f"è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜ã‚¨ãƒ©ãƒ¼: {e}")
        return False


# ã‚°ãƒ­ãƒ¼ãƒãƒ«è¨­å®š
config = load_config()


# ==================== ã‚¿ãƒ–1: ç”»åƒæº–å‚™ ====================

def prepare_images_pipeline(
    input_dir: str,
    progress=gr.Progress()
) -> str:
    """
    ç”»åƒæº–å‚™ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³: ãƒªã‚µã‚¤ã‚º â†’ è‡ªå‹•ã‚¿ã‚°ä»˜ã‘ â†’ å…±é€šã‚¿ã‚°è¿½åŠ 

    Args:
        input_dir: å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãƒ‘ã‚¹
        progress: Gradioé€²æ—è¡¨ç¤ºã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ

    Returns:
        å‡¦ç†çµæœãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    """
    try:
        input_path = Path(input_dir)
        if not input_path.exists():
            error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: å…¥åŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: {input_dir}"
            logger.error(error_msg)
            return error_msg

        # å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®è¨­å®š
        processed_dir = Path(config["default_processed_dir"])
        tagged_dir = Path(config["default_tagged_dir"])
        processed_dir.mkdir(parents=True, exist_ok=True)
        tagged_dir.mkdir(parents=True, exist_ok=True)

        result_messages = []

        # ã‚¹ãƒ†ãƒƒãƒ—1: ç”»åƒã®ãƒªã‚µã‚¤ã‚ºã¨ãƒªãƒãƒ¼ãƒ 
        progress(0.0, desc="ã‚¹ãƒ†ãƒƒãƒ—1/3: ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºä¸­...")
        logger.info(f"ã‚¹ãƒ†ãƒƒãƒ—1: ç”»åƒãƒªã‚µã‚¤ã‚ºé–‹å§‹ ({input_dir} â†’ {processed_dir})")

        image_files = get_image_files(input_path)
        if not image_files:
            error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {input_dir}"
            logger.error(error_msg)
            return error_msg

        total_images = len(image_files)
        result_messages.append(f"ğŸ“ å…¥åŠ›ç”»åƒæ•°: {total_images}æš")

        # ç”»åƒå‡¦ç†
        from PIL import Image
        for i, img_file in enumerate(image_files):
            progress((i / total_images) * 0.33, desc=f"ãƒªã‚µã‚¤ã‚ºä¸­: {img_file.name} ({i+1}/{total_images})")

            # ç”»åƒèª­ã¿è¾¼ã¿
            img = Image.open(img_file)

            # ãƒªã‚µã‚¤ã‚º & ã‚¯ãƒ­ãƒƒãƒ—
            img_resized = resize_and_crop(img, config["image_size"])

            # ä¿å­˜ï¼ˆé€£ç•ªãƒªãƒãƒ¼ãƒ ï¼‰
            output_filename = f"img{i+1:03d}.png"
            output_path = processed_dir / output_filename
            img_resized.save(output_path, "PNG")
            logger.info(f"ä¿å­˜: {output_path}")

        result_messages.append(f"âœ… ã‚¹ãƒ†ãƒƒãƒ—1å®Œäº†: {total_images}æšã®ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¾ã—ãŸ")

        # ã‚¹ãƒ†ãƒƒãƒ—2: è‡ªå‹•ã‚¿ã‚°ä»˜ã‘
        progress(0.33, desc="ã‚¹ãƒ†ãƒƒãƒ—2/3: è‡ªå‹•ã‚¿ã‚°ä»˜ã‘ä¸­...")
        logger.info(f"ã‚¹ãƒ†ãƒƒãƒ—2: è‡ªå‹•ã‚¿ã‚°ä»˜ã‘é–‹å§‹ ({processed_dir} â†’ {tagged_dir})")

        tagger = WD14Tagger(threshold=config["caption_threshold"], use_coreml=False)
        processed_images = list(processed_dir.glob("*.png"))

        for i, img_file in enumerate(processed_images):
            progress(0.33 + (i / len(processed_images)) * 0.33,
                    desc=f"ã‚¿ã‚°ä»˜ã‘ä¸­: {img_file.name} ({i+1}/{len(processed_images)})")

            # ã‚¿ã‚°ç”Ÿæˆ
            tags = tagger.predict(str(img_file))

            # ç”»åƒã¨ã‚¿ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
            output_img_path = tagged_dir / img_file.name
            output_txt_path = tagged_dir / (img_file.stem + ".txt")

            # ç”»åƒã‚³ãƒ”ãƒ¼
            import shutil
            shutil.copy2(img_file, output_img_path)

            # ã‚¿ã‚°ä¿å­˜
            output_txt_path.write_text(", ".join(tags), encoding='utf-8')
            logger.info(f"ã‚¿ã‚°ä»˜ã‘: {output_img_path.name} -> {len(tags)}å€‹ã®ã‚¿ã‚°")

        result_messages.append(f"âœ… ã‚¹ãƒ†ãƒƒãƒ—2å®Œäº†: {len(processed_images)}æšã®ç”»åƒã«ã‚¿ã‚°ã‚’ä»˜ã‘ã¾ã—ãŸ")

        # ã‚¹ãƒ†ãƒƒãƒ—3: å…±é€šã‚¿ã‚°è¿½åŠ 
        progress(0.66, desc="ã‚¹ãƒ†ãƒƒãƒ—3/3: å…±é€šã‚¿ã‚°è¿½åŠ ä¸­...")
        logger.info(f"ã‚¹ãƒ†ãƒƒãƒ—3: å…±é€šã‚¿ã‚°'{config['common_tag']}'ã‚’è¿½åŠ ä¸­")

        txt_files = list(tagged_dir.glob("*.txt"))
        added_count = 0

        for i, txt_file in enumerate(txt_files):
            progress(0.66 + (i / len(txt_files)) * 0.33,
                    desc=f"å…±é€šã‚¿ã‚°è¿½åŠ ä¸­: {txt_file.name} ({i+1}/{len(txt_files)})")

            if add_tag_to_file(txt_file, config["common_tag"], position="start"):
                added_count += 1

        result_messages.append(f"âœ… ã‚¹ãƒ†ãƒƒãƒ—3å®Œäº†: {added_count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«å…±é€šã‚¿ã‚°ã‚’è¿½åŠ ã—ã¾ã—ãŸ")

        # å®Œäº†
        progress(1.0, desc="âœ… å…¨å‡¦ç†å®Œäº†!")
        logger.info("ç”»åƒæº–å‚™ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†")

        result_messages.append(f"\nğŸ‰ ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ!")
        result_messages.append(f"ğŸ“‚ å‡ºåŠ›å…ˆ: {tagged_dir}")

        return "\n".join(result_messages)

    except Exception as e:
        error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {str(e)}"
        logger.exception(error_msg)
        return error_msg


# ==================== ã‚¿ãƒ–2: ã‚¿ã‚°ç·¨é›† ====================

def load_tagged_images() -> List[Tuple[str, str]]:
    """ã‚¿ã‚°ä»˜ãç”»åƒã‚’èª­ã¿è¾¼ã‚€"""
    tagged_dir = Path(config["default_tagged_dir"])
    if not tagged_dir.exists():
        return []

    image_files = sorted(tagged_dir.glob("*.png"))
    # Gradioã®ã‚®ãƒ£ãƒ©ãƒªãƒ¼å½¢å¼: [(image_path, caption), ...]
    return [(str(img), img.stem) for img in image_files]


def load_tags_for_image(image_path: str) -> str:
    """æŒ‡å®šç”»åƒã®ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€"""
    if not image_path:
        return ""

    img_path = Path(image_path)
    txt_path = img_path.with_suffix(".txt")

    if txt_path.exists():
        return txt_path.read_text(encoding='utf-8')
    return ""


def save_tags_for_image(image_path: str, tags: str) -> str:
    """æŒ‡å®šç”»åƒã®ã‚¿ã‚°ã‚’ä¿å­˜ã™ã‚‹"""
    if not image_path:
        return "âŒ ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"

    try:
        img_path = Path(image_path)
        txt_path = img_path.with_suffix(".txt")

        txt_path.write_text(tags, encoding='utf-8')
        logger.info(f"ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {txt_path}")
        return f"âœ… ã‚¿ã‚°ã‚’ä¿å­˜ã—ã¾ã—ãŸ: {txt_path.name}"
    except Exception as e:
        error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
        logger.error(error_msg)
        return error_msg


def add_tag_to_selected_images(selected_indices: List[int], tag_to_add: str, gallery_images: List) -> str:
    """é¸æŠã—ãŸç”»åƒã«å›ºæœ‰ã‚¿ã‚°ã‚’è¿½åŠ """
    if not selected_indices:
        return "âŒ ç”»åƒãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“"

    if not tag_to_add.strip():
        return "âŒ è¿½åŠ ã™ã‚‹ã‚¿ã‚°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"

    try:
        added_count = 0
        for idx in selected_indices:
            if idx < len(gallery_images):
                image_path = gallery_images[idx][0]
                img_path = Path(image_path)
                txt_path = img_path.with_suffix(".txt")

                if add_tag_to_file(txt_path, tag_to_add.strip(), position="start"):
                    added_count += 1

        logger.info(f"{added_count}å€‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¿ã‚°'{tag_to_add}'ã‚’è¿½åŠ ã—ã¾ã—ãŸ")
        return f"âœ… {added_count}å€‹ã®ç”»åƒã«ã‚¿ã‚°'{tag_to_add}'ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
    except Exception as e:
        error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
        logger.error(error_msg)
        return error_msg


# ==================== ã‚¿ãƒ–3: å­¦ç¿’ãƒ»ãƒ¢ãƒ‡ãƒ«ç®¡ç† ====================

def upload_to_google_drive_stub() -> str:
    """Google Driveã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼‰"""
    return "âš ï¸ ã“ã®æ©Ÿèƒ½ã¯å°†æ¥å®Ÿè£…äºˆå®šã§ã™\nç¾åœ¨ã¯æ‰‹å‹•ã§Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"


def download_model_from_drive_stub() -> str:
    """Google Driveã‹ã‚‰ãƒ¢ãƒ‡ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆã‚¹ã‚¿ãƒ–å®Ÿè£…ï¼‰"""
    return "âš ï¸ ã“ã®æ©Ÿèƒ½ã¯å°†æ¥å®Ÿè£…äºˆå®šã§ã™\nç¾åœ¨ã¯æ‰‹å‹•ã§ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„"


def deploy_model_to_sd_webui() -> str:
    """Stable Diffusion WebUIã«ãƒ¢ãƒ‡ãƒ«ã‚’é…ç½®"""
    try:
        lora_models_dir = Path(config["default_lora_models_dir"])
        sd_webui_path = Path(config["sd_webui_path"])

        if not lora_models_dir.exists():
            return f"âŒ LoRAãƒ¢ãƒ‡ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ã¾ã›ã‚“: {lora_models_dir}"

        # .safetensorsãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢
        model_files = list(lora_models_dir.glob("*.safetensors"))

        if not model_files:
            return f"âŒ ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«(.safetensors)ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: {lora_models_dir}"

        # SD WebUIãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ
        sd_webui_path.mkdir(parents=True, exist_ok=True)

        # ãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
        import shutil
        copied_count = 0
        for model_file in model_files:
            dest_path = sd_webui_path / model_file.name
            shutil.copy2(model_file, dest_path)
            logger.info(f"ãƒ¢ãƒ‡ãƒ«ã‚’ã‚³ãƒ”ãƒ¼: {model_file.name} â†’ {dest_path}")
            copied_count += 1

        return f"âœ… {copied_count}å€‹ã®ãƒ¢ãƒ‡ãƒ«ã‚’Stable Diffusion WebUIã«é…ç½®ã—ã¾ã—ãŸ\nğŸ“‚ {sd_webui_path}"

    except Exception as e:
        error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
        logger.error(error_msg)
        return error_msg


# ==================== ã‚¿ãƒ–4: è¨­å®š ====================

def load_settings() -> Tuple[str, str]:
    """è¨­å®šã‚’èª­ã¿è¾¼ã‚€"""
    return config["sd_webui_path"], config["training_mode"]


def save_settings(sd_path: str, training_mode: str) -> str:
    """è¨­å®šã‚’ä¿å­˜ã™ã‚‹"""
    try:
        config["sd_webui_path"] = sd_path
        config["training_mode"] = training_mode

        if save_config(config):
            return "âœ… è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ"
        else:
            return "âŒ è¨­å®šã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"
    except Exception as e:
        error_msg = f"âŒ ã‚¨ãƒ©ãƒ¼: {str(e)}"
        logger.error(error_msg)
        return error_msg


# ==================== Gradio UI ====================

def create_ui():
    """Gradio UIã‚’ä½œæˆ"""

    with gr.Blocks(title="Nasumiso LoRA Training Assistant", theme=gr.themes.Soft()) as app:
        gr.Markdown("# ğŸ¨ Nasumiso LoRA Training Assistant")
        gr.Markdown("ãªã™ã¿ãLoRAå­¦ç¿’ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆãƒ„ãƒ¼ãƒ«")

        with gr.Tabs():
            # ã‚¿ãƒ–1: ç”»åƒæº–å‚™
            with gr.Tab("ğŸ“ ç”»åƒæº–å‚™"):
                gr.Markdown("### ç”»åƒã®ãƒªã‚µã‚¤ã‚ºãƒ»è‡ªå‹•ã‚¿ã‚°ä»˜ã‘ãƒ»å…±é€šã‚¿ã‚°è¿½åŠ ã‚’ä¸€æ‹¬å®Ÿè¡Œ")

                with gr.Row():
                    input_dir = gr.Textbox(
                        label="å…¥åŠ›ãƒ•ã‚©ãƒ«ãƒ€",
                        value=config["default_raw_images_dir"],
                        placeholder="ä¾‹: projects/nasumiso_v1/1_raw_images"
                    )

                prepare_btn = gr.Button("ğŸš€ å¤‰æ›é–‹å§‹", variant="primary", size="lg")
                result_text = gr.Textbox(label="å‡¦ç†çµæœ", lines=10, interactive=False)

                prepare_btn.click(
                    fn=prepare_images_pipeline,
                    inputs=[input_dir],
                    outputs=[result_text]
                )

            # ã‚¿ãƒ–2: ã‚¿ã‚°ç·¨é›†
            with gr.Tab("ğŸ·ï¸ ã‚¿ã‚°ç·¨é›†"):
                gr.Markdown("### ç”»åƒã”ã¨ã®ã‚¿ã‚°è¡¨ç¤ºãƒ»ç·¨é›†ã€å›ºæœ‰ã‚¿ã‚°ã®è¿½åŠ ")

                with gr.Row():
                    refresh_gallery_btn = gr.Button("ğŸ”„ ç”»åƒä¸€è¦§ã‚’æ›´æ–°")

                gallery = gr.Gallery(
                    label="ç”»åƒä¸€è¦§",
                    show_label=True,
                    columns=4,
                    height="auto"
                )

                selected_image = gr.State(None)

                with gr.Row():
                    with gr.Column(scale=2):
                        tags_textbox = gr.Textbox(
                            label="ã‚¿ã‚°ï¼ˆã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰",
                            lines=5,
                            placeholder="ã‚¿ã‚°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„"
                        )
                    with gr.Column(scale=1):
                        save_tags_btn = gr.Button("ğŸ’¾ ã‚¿ã‚°ã‚’ä¿å­˜", variant="primary")
                        save_result = gr.Textbox(label="ä¿å­˜çµæœ", lines=2, interactive=False)

                gr.Markdown("---")
                gr.Markdown("### å›ºæœ‰ã‚¿ã‚°ä¸€æ‹¬è¿½åŠ ï¼ˆå°†æ¥å®Ÿè£…äºˆå®šï¼‰")
                gr.Markdown("âš ï¸ ç¾åœ¨ã¯1æšãšã¤ã‚¿ã‚°ã‚’ç·¨é›†ã—ã¦ãã ã•ã„")

                # ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
                refresh_gallery_btn.click(
                    fn=load_tagged_images,
                    inputs=[],
                    outputs=[gallery]
                )

                # ç”»åƒé¸æŠæ™‚ã«ã‚¿ã‚°ã‚’èª­ã¿è¾¼ã‚€ï¼ˆç°¡æ˜“å®Ÿè£…: æœ€åˆã®ç”»åƒã®ã¿ï¼‰
                gallery.select(
                    fn=lambda evt: evt.value if evt else None,
                    inputs=None,
                    outputs=[selected_image]
                )

            # ã‚¿ãƒ–3: å­¦ç¿’ãƒ»ãƒ¢ãƒ‡ãƒ«ç®¡ç†
            with gr.Tab("ğŸ¤– å­¦ç¿’ãƒ»ãƒ¢ãƒ‡ãƒ«ç®¡ç†"):
                gr.Markdown("### Google Driveé€£æºã¨ãƒ¢ãƒ‡ãƒ«ç®¡ç†")

                # Google Driveé€£æº
                gr.Markdown("#### Google Driveé€£æº")
                upload_btn = gr.Button("â˜ï¸ Google Driveã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰", variant="secondary")
                upload_result = gr.Textbox(label="ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰çµæœ", lines=3, interactive=False)

                upload_btn.click(
                    fn=upload_to_google_drive_stub,
                    inputs=[],
                    outputs=[upload_result]
                )

                gr.Markdown("---")

                # Google Colabé€£æº
                gr.Markdown("#### Google Colabå­¦ç¿’")
                gr.Markdown(
                    "[ğŸ““ Google Colabã§å­¦ç¿’ã‚’é–‹å§‹](https://colab.research.google.com/github/yourusername/NasumisoCreator/blob/main/notebooks/train_lora_nasutomo.ipynb)",
                    elem_id="colab_link"
                )
                gr.Markdown("â€» ä¸Šè¨˜ãƒªãƒ³ã‚¯ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦Colabãƒãƒ¼ãƒˆãƒ–ãƒƒã‚¯ã‚’é–‹ãã€ã‚»ãƒ«ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„")

                gr.Markdown("---")

                # ãƒ¢ãƒ‡ãƒ«ç®¡ç†
                gr.Markdown("#### ãƒ¢ãƒ‡ãƒ«ç®¡ç†")
                download_btn = gr.Button("â¬‡ï¸ ãƒ¢ãƒ‡ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰", variant="secondary")
                download_result = gr.Textbox(label="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰çµæœ", lines=3, interactive=False)

                deploy_btn = gr.Button("ğŸš€ Stable Diffusionã«é…ç½®", variant="primary")
                deploy_result = gr.Textbox(label="é…ç½®çµæœ", lines=3, interactive=False)

                download_btn.click(
                    fn=download_model_from_drive_stub,
                    inputs=[],
                    outputs=[download_result]
                )

                deploy_btn.click(
                    fn=deploy_model_to_sd_webui,
                    inputs=[],
                    outputs=[deploy_result]
                )

            # ã‚¿ãƒ–4: è¨­å®š
            with gr.Tab("âš™ï¸ è¨­å®š"):
                gr.Markdown("### ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š")

                sd_path_input = gr.Textbox(
                    label="Stable Diffusion WebUI LoRAãƒ¢ãƒ‡ãƒ«ãƒ‘ã‚¹",
                    value=config["sd_webui_path"],
                    placeholder="ä¾‹: /Users/username/stable-diffusion-webui/models/Lora"
                )

                training_mode_radio = gr.Radio(
                    label="å­¦ç¿’ãƒ¢ãƒ¼ãƒ‰",
                    choices=["colab", "local"],
                    value=config["training_mode"],
                    info="ç¾åœ¨ã¯colabã®ã¿ã‚µãƒãƒ¼ãƒˆï¼ˆlocalã¯å°†æ¥å®Ÿè£…äºˆå®šï¼‰"
                )

                save_settings_btn = gr.Button("ğŸ’¾ è¨­å®šã‚’ä¿å­˜", variant="primary")
                settings_result = gr.Textbox(label="ä¿å­˜çµæœ", lines=2, interactive=False)

                save_settings_btn.click(
                    fn=save_settings,
                    inputs=[sd_path_input, training_mode_radio],
                    outputs=[settings_result]
                )

        gr.Markdown("---")
        gr.Markdown("Made with â¤ï¸ for Nasumiso")

    return app


if __name__ == "__main__":
    logger.info("Nasumiso LoRA Training Assistant èµ·å‹•ä¸­...")

    app = create_ui()
    app.launch(
        server_name="127.0.0.1",
        server_port=7861,
        share=False,
        show_error=True
    )
